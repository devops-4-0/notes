[Main menu](../../README.md)

### **Configuring IP Tables in Ubuntu**

IPTables is a powerful firewall tool in Linux for managing packet filtering and routing. It allows you to define rules for incoming, outgoing, and forwarded packets.

---

### **Key Components of IPTables**

IPTables operates on three key **tables**:
1. **`filter` Table**: Handles packet filtering (default table).
   - Chains: `INPUT`, `FORWARD`, `OUTPUT`.
2. **`nat` Table**: Handles network address translation (NAT).
   - Chains: `PREROUTING`, `POSTROUTING`, `OUTPUT`.
3. **`mangle` Table**: Handles packet alteration (e.g., TTL changes).
   - Chains: `PREROUTING`, `POSTROUTING`, `INPUT`, `FORWARD`, `OUTPUT`.
4. **`raw` Table**: Excludes certain packets from connection tracking.
   - Chains: `PREROUTING`, `OUTPUT`.

---

### **Key Chains**
- **`PREROUTING`**: Packets arriving at the system (used for DNAT).
- **`INPUT`**: Packets destined for the system.
- **`FORWARD`**: Packets routed through the system.
- **`OUTPUT`**: Packets generated by the system.
- **`POSTROUTING`**: Packets leaving the system (used for SNAT).

---

### **Basic IPTables Commands**

1. **View Current Rules**:
   ```bash
   sudo iptables -L -v -n
   ```

2. **Flush All Rules**:
   ```bash
   sudo iptables -F
   ```

3. **Delete a Specific Rule**:
   ```bash
   sudo iptables -D INPUT 1  # Deletes the first rule in the INPUT chain
   ```

4. **Save Rules**:
   Save rules to persist across reboots.
   ```bash
   sudo iptables-save > /etc/iptables/rules.v4
   ```

5. **Restore Rules**:
   ```bash
   sudo iptables-restore < /etc/iptables/rules.v4
   ```

---

### **Example Configurations**

#### **1. Block All Incoming Traffic Except SSH**
```bash
sudo iptables -P INPUT DROP
sudo iptables -P FORWARD DROP
sudo iptables -P OUTPUT ACCEPT
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
```

---

#### **2. NAT Example (Port Forwarding with DNAT)**

Forward packets destined to port `8080` on the public IP to an internal server (`192.168.1.100`) on port `80`:
```bash
sudo iptables -t nat -A PREROUTING -p tcp --dport 8080 -j DNAT --to-destination 192.168.1.100:80
sudo iptables -A FORWARD -p tcp -d 192.168.1.100 --dport 80 -j ACCEPT
```

---

#### **3. Source NAT (SNAT)**

When traffic from an internal network (`192.168.1.0/24`) is routed through a server with IP `203.0.113.1`, replace the source IP with the server's public IP:
```bash
sudo iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j SNAT --to-source 203.0.113.1
```

---

#### **4. Masquerading**

Masquerading dynamically translates the source address for outgoing packets:
```bash
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```

---

#### **5. Block Specific IP**

Block all incoming traffic from a specific IP (`203.0.113.5`):
```bash
sudo iptables -A INPUT -s 203.0.113.5 -j DROP
```

---

#### **6. Allow Traffic to Specific Ports**

Allow HTTP and HTTPS traffic:
```bash
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
```

---

#### **7. Enable Packet Forwarding**

Edit `/etc/sysctl.conf` and enable IP forwarding:
```bash
net.ipv4.ip_forward=1
```

Apply the change:
```bash
sudo sysctl -p
```

---

### **Routing with IPTables**

#### **PREROUTING and POSTROUTING**

1. **PREROUTING**:
   - Used for altering packets **before** they reach the routing decision phase.
   - Example: Forwarding external traffic to an internal server.

2. **POSTROUTING**:
   - Used for altering packets **after** they have been routed but **before** leaving the system.
   - Example: Masquerading for outgoing packets.

---

#### **Example: Simple Router**
Route traffic from `192.168.1.0/24` (LAN) to the internet via `eth0`:
1. Enable IP forwarding:
   ```bash
   sudo sysctl -w net.ipv4.ip_forward=1
   ```
2. Configure NAT:
   ```bash
   sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
   ```
3. Allow forwarding:
   ```bash
   sudo iptables -A FORWARD -i eth1 -o eth0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
   sudo iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT
   ```

---

### **Save Rules for Persistence**

1. **Install `iptables-persistent`**:
   ```bash
   sudo apt install iptables-persistent
   ```

2. **Save Current Rules**:
   ```bash
   sudo netfilter-persistent save
   ```

3. **Restore Rules on Boot**:
   ```bash
   sudo systemctl enable netfilter-persistent
   ```

---

### **Debugging Tools**

1. **View Rules**:
   ```bash
   sudo iptables -L -t nat -v
   ```

2. **Monitor Traffic**:
   ```bash
   sudo iptables -A INPUT -j LOG --log-prefix "IPTables Input: "
   tail -f /var/log/syslog
   ```

3. **Check Connections**:
   ```bash
   sudo conntrack -L
   ```

---

[Main menu](../../README.md)